@(spaceForm: Form[forms.SpaceForm], records: List[Record], spaces: List[Space], activeSpace: org.bson.types.ObjectId, user: String)

@getCreators(records: List[Record]) = @{
	val creators = new Set()
	for(r <- records) {
		creators = creators ++ r.creator
	}
	return creators
}

@main(user, "spaces") {
	<div class="page-header">
		<h1>My spaces</h1>
	</div>
	
	@if(spaceForm.hasGlobalErrors) {
		<div class="alert alert-danger alert-dismissable">
			<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
			@spaceForm.globalError.message
		</div>
	}
	
	<!-- Manually add a new record here -->
	<button type="button" data-toggle="modal" data-target="#newRecordForm" class="btn btn-primary pull-right">
		<span class="glyphicon glyphicon-plus"></span> Manually add a new record
	</button>
	@helper.form(routes.Spaces.manuallyAddRecord) {
		<div class="modal fade" id="newRecordForm" role="dialog" aria-labelledby="newRecordFormLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="newRecordFormLabel">Create a new space</h4>
					</div>
					<div class="modal-body">
						<textarea class="form-control" rows="3" placeholder="Record data" name="data" autofocus></textarea>
						<input type="text" class="form-control" placeholder="Tags (by which you can find this record when searching)" name="tags">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Create</button>
					</div>
				</div> <!-- /.modal-content -->
			</div> <!-- /.modal-dialog -->
		</div> <!-- /.modal -->
	}
	
	<!-- Space tabs -->
	<ul id="spaceTabs" class="nav nav-tabs">
		<li class="@if(activeSpace == null){active}">
			<a href="#tab-default" data-toggle="tab">All records</a>
		</li>
		@spaces.map { space =>
			<li tab-id="@space._id" class="spaceTab @if(space._id.equals(activeSpace)){active}">
				<a href="#tab-@space._id" data-toggle="tab"><span class="spaceName">@space.name</span></a>
			</li>
		}
		<!-- Add new space button -->
		<li>
			<button data-toggle="modal" data-target="#spaceForm" class="btn btn-default">
				<span class="glyphicon glyphicon-plus"></span>
			</button>
		</li>
	</ul>
	
	<!-- Space content -->
	<div id="spaceContent" class="tab-content">
		<div id="tab-default" class="space tab-pane fade @if(activeSpace == null){active in}">
			<p class="activeFilters"></p>
			<p>Filter the displayed records by:
				<div class="dropdown">
					<button type="button" class="btn btn-link" data-toggle="dropdown">Creator</button>
					<ul class="dropdown-menu" aria-labelledby="default-creator-dropdown">
						@getCreators(records).map { creator =>
							<li><a href="#">@User.getName(creator)</a></li>
						}
					</ul>
				</div>
			</p>
			<form id="form-default" action="@routes.Visualizations.list" method="post" target="iframe-default">
				@records.map { record =>
					<input type="hidden" name="@record._id creator" value="@record.creator">
					<input type="hidden" name="@record._id owner" value="@record.owner">
					<input type="hidden" name="@record._id created" value="@record.created">
					<input type="hidden" name="@record._id data" value="@record.data">
				}
			</form>
		<!-- 
		 	<a href="" id="loadSpace" target="spaceIFrame">Load space!</a>
		 -->
			<iframe id="iframe-default" src="@routes.Visualizations.loading" height="420px" width="100%"></iframe>
		
		<!-- 
			<div class="list-group">
				<span class="list-group-item active">Records</span>
				@if(records.size() > 0) {
					@records.map { record =>
						<a href="" class="record list-group-item">
							@Record.dataToString(record.data)
						</a>
					}
				} else {
					<p class="list-group-item">You have no records available yet.</p>
				}
			</div>
		 -->
		 
		</div>
		@spaces.map { space =>
			<!-- views.html.elements.space(records, space, activeSpace) -->
			<div class="space tab-pane fade @if(space._id.equals(activeSpace)){active in}" id="tab-@space._id">
				<form id="form-@space._id" action="@routes.Visualizations.list" method="post" target="iframe-@space._id">
					<input type="hidden" name="spaceId" value="@space._id">
					@records.filter((record) => space.records.contains(record._id)).map { record =>
						<input type="hidden" name="@record._id creator" value="@record.creator">
						<input type="hidden" name="@record._id owner" value="@record.owner">
						<input type="hidden" name="@record._id created" value="@record.created">
						<input type="hidden" name="@record._id data" value="@record.data">
					}
				</form>
				<iframe id="iframe-@space._id" src="@routes.Visualizations.loading" height="420px" width="100%"></iframe>
			</div>
		}
	</div>

	<!-- New space modal -->
	@helper.form(routes.Spaces.add) {
		<div class="modal fade" id="spaceForm" role="dialog" aria-labelledby="spaceFormLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="spaceFormLabel">Create a new space</h4>
					</div>
					<div class="modal-body">
						<input type="text" class="form-control" placeholder="Name" name="name" value="@spaceForm("name").value" autofocus>
						<input type="text" class="form-control" placeholder="Visualization (to be replaced by dropdown list)" name="visualization">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Create</button>
					</div>
				</div> <!-- /.modal-content -->
			</div> <!-- /.modal-dialog -->
		</div> <!-- /.modal -->
	}

	<!-- Load specific js -->
	<script type="text/javascript" src="@routes.Assets.at("javascripts/spaces.js")"></script>
}
